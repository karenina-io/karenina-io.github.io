<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v7.0"
        nonce="HMvCBx1d"></script>
<!--<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v7.0" nonce="HXqTTFYP"></script>-->

<script>window.twttr = (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
        t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);

    t._e = [];
    t.ready = function (f) {
        t._e.push(f);
    };

    return t;
}(document, "script", "twitter-wjs"));</script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<!-- Popper JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<meta charset="UTF-8">

<script>
    const MAX_LEN = 150
    const MAX_DAILY = 10;
    const MAX_DAILY0 = 14;
    // const MAX1 = 240
    // const MARKS = [ ['maybe','old'],['new']]

    // if ('replace' in localStorage) {
    // } else {
    //     localStorage.setItem('replace', true)
    // }
    // $('#replace').prop('checked', localStorage.getItem('replace') == 'true')
    // document.getElementById('replace').addEventListener('change', (event) => {
    //     let checked = event.target.checked
    //     // prompt(checked)
    //     localStorage.setItem('replace', checked)
    // })


    function toggle(el) {
        let state = Number(el.getAttribute('state'))
        let lvl = Number(el.getAttribute('lvl'))
        let text = el.getAttribute('alt')


        el.setAttribute('alt', el.innerText)
        el.innerText = text

        state = 1 - state
        el.setAttribute('state', state)

        lvl = Math.min(lvl, 1)
        let mark = state ? 'new' : ['maybe', 'old'][lvl]

        el.setAttribute('class', mark)
        // el.style.backgroundColor = colors[state]
        // el.style.textDecorationColor = colors[state]
    }

    const SAMPLES = {
        'en': 'he need buy aple and cereal. he will arrive there in 5 minutesss to make shopping in store',
        'zh': '我是坐着地铁来去办公室',
        'es': 'me no gustar comer los pizza por almerzo',
        'fr': 'je aimer mange les vegetables',
        'ja': '私イタリアで住でいます。',
        'ko': '나는좋아한다사과를.',
        'de': 'Du liebst ich.',
        'it': 'A me mi piace il gelato',
        'pt': 'Porque ele ainda no chegou?',
        'ar': '
    }

    function fill(lang) {
        $('#text').text(SAMPLES[lang])
    }

    function clearInput() {
        document.getElementById('text').innerHTML = ''
        $('#text').empty()
    }

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const lang = urlParams.get('lang')
    if (lang) {
        fill(lang)
    }

    const copyToClipBoard = (str) => {
        const el = document.createElement('textarea');
        el.value = str;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
    };

    function copy() {
        $('.old').remove()
        // $('.old').remove()
        $('#text').html($('#text').text())
        copyToClipBoard(document.getElementById('text').innerText)
    }

    // function paste() {
    //     let tArea = document.getElementById('text')
    //     tArea.innerText = '';
    //     tArea.focus();
    //     tArea.select();
    //     document.execCommand('paste');
    // }

    function write() {
        chrome.tabs.sendMessage(window.id, {
            action: "write",
            q: document.getElementById('text').innerText
        }, function (response) {
        });
        window.close()
    }

    // We're an AI startup founded by Stanford University alumni dedicated to breaking down barriers between languages and cultures.
    // function copy( ) {
    //         let tArea = document.createElement('textarea');
    //         document.body.appendChild(tArea);
    //         tArea.value = '';
    //         tArea.focus();
    //         tArea.select();
    //         document.execCommand('paste');
    //         let old = tArea.value;
    //
    //
    //         tArea.value = request.q;
    //         tArea.select();
    //         document.execCommand('copy');
    //
    //         window.close()
    // }


    // const app = new Vue({
    //     el: '#app',
    //     data: {
    //         html: '',
    //         cors: []
    //     },
    //     methods: {
    function correct() {

        let q = document.getElementById('text').innerText
        console.log(q)
        let url = 'https://us-central1-project-318531836785902414.cloudfunctions.net/f'
        // let url = 'https://us-central1-project-318531836785902414.cloudfunctions.net/correct'

        let data = {
            'q': q.trim(),
        }

        fetch(url, {
            method: 'POST', // *GET, POST, PUT, DELETE, etc.
            headers: {
                'Accept': 'application/json',
            },
            body: JSON.stringify(data) // body data type must match "Content-Type" header
        }).then(r => {
            console.log(r)
            return r.json()
        }).then(r => {
            console.log(r)

            let {corrections, input, output} = r
            let html = input
            let i = corrections.length
            for (let x of corrections.reverse()) {
                i--
                // let replace = localStorage.getItem('replace') == 'true'
                // prompt(replace)
                // if (replace) {
                //     html = html.substring(0, x['start']) + `<mark class="new" id="${i}" alt="${x.old}" state="1" lvl="${x.lvl}" onclick="toggle(this)">${x.new}</mark>` + html.substring(x['end'])
                // } else {
                //     html = html.substring(0, x['start']) + `<mark class="old" id="${i}" alt="${x.new}" state="0" lvl="${x.lvl}" onclick="toggle(this)">${x.old}</mark>` + html.substring(x['end'])
                //
                // }
                html = html.substring(0, x['start']) +
                    `<span class="old" id="${i}old" onclick="$(this).replaceWith('${x.old}'); $('#${i}new').remove()">${x.old}</span>` +
                    `<span class="new" id="${i}new" onclick="$(this).replaceWith('${x.new}'); $('#${i}old').remove()">${x.new}</span>` +
                    html.substring(x['end'])
                // html = html.substring(0, x['start']) + `<span id="${i}" class="cor" alt="${x.old}" state="1" onclick="toggle(this)">${x.new}</span>` + html.substring(x['end'])
                // html = html.substring(0, x['start']) + `<span id="${i}" class="cor" alt="${x.old}" state="1" onclick="toggle(this)">${x['new']}</span>` + html.substring(x['end'])
            }
            $('#text').html(html)
            // $('#output').html(output)
            refresh()

        })
    }

    // 615
    function nqueries() {
        let n = localStorage.getItem('nqueries')
        if (n === null) {
            localStorage.setItem('nqueries', MAX_DAILY0)
            localStorage.setItem('last', Date.now())
        } else {
            n = Number(n)
            if (n === 0) {
                if (Date.now() - localStorage.getItem('last') > 3600000 * 24) {
                    localStorage.setItem('last', Date.now())
                    localStorage.setItem('nqueries', MAX_DAILY)
                }
            }
        }
        n = Number(localStorage.getItem('nqueries'))
        console.log(`n: ${n}`)
        return n
    }

    function spend(customer, n, f, g) {
        let data = {
            customer: customer,
            n: n,
            action: 'spend'
        }
        console.log(data)
        query(data, r => {
            console.log(r)
            if (r.status === 'success') {
                f()
            } else {
                g()
                refresh()
            }
        })
    }

    function prompt(m) {
        alert(m)
        refresh()
    }

    function analyze() {
        $('#analyze').text('Processing...')

        let len = document.getElementById('text').innerText.length
        let customer = localStorage.getItem('customer')

        if (len > MAX_LEN) {
            if (!customer) {
                prompt(`Input text length is too long. Enter a shorter length or subscribe to a plan in the Accounts tab.`)

            } else {
                spend(customer, len, correct, () => {
                    prompt(`Input text length is too long. There's no subscription or your subscription credits ran out. Enter a shorter length or subscribe to a plan in the Accounts tab.`)
                })
            }
        } else {
            let n = nqueries();
            if (n > MAX_DAILY) {
                localStorage.setItem('nqueries', n - 1)
                correct()
            } else {
                if (!customer) {
                    prompt('Please register or login for more free usage ')
                } else {
                    if (n === 0) {
                        spend(customer, len, correct, () => {
                            prompt(`Your free usage for today ran out. Check back tomorrow or subscribe to a plan.`)
                        })
                    } else {
                        localStorage.setItem('nqueries', n - 1)
                        correct()
                    }
                }
            }
        }
    }

    function refresh() {

        if (localStorage.getItem('customer')) {
            $('#free').hide()
        } else {
            $('#free').show()


        }
        $('#analyze').text('Analyze')
    }

    refresh()


</script>

<style>

    .old {
        cursor: pointer;
        background-color: pink;
        text-decoration: red line-through;
    }

    .new {
        cursor: pointer;
        background-color: lightgreen;
        text-decoration: green underline double;
    }

</style>

<!--    <title>Karenina IO multilingual grammar and style checker</title>-->

<!--#include virtual="/nav" -->
<div class="container" id="app">

    <div class="row">
        <div class="col">
            <!--            <h5>Input</h5>-->

            <!--                he need buy aple and cereal for lunch. he will be their in 5 minuts to make shopping in store-->
            <h6>Sample inputs (*denotes experimental) </h6>
            <button class="btn btn-outline-danger" onclick="fill('en')">English</button>
            <button class="btn btn-outline-danger" onclick="fill('es')">Spanish</button>
            <button class="btn btn-outline-danger" onclick="fill('pt')">Portuguese</button>
            <button class="btn btn-outline-danger" onclick="fill('zh')">Chinese</button>
            <button class="btn btn-outline-danger" onclick="fill('ar')">Arabic*</button>
            <button class="btn btn-outline-danger" onclick="fill('ja')">Japanese*</button>
            <button class="btn btn-outline-danger" onclick="fill('ko')">Korean*</button>
            <button class="btn btn-outline-danger" onclick="fill('fr')">French*</button>
            <button class="btn btn-outline-danger" onclick="fill('de')">German*</button>
            <button class="btn btn-outline-danger" onclick="fill('it')">Italian*</button>

            <br>
            <br>
            <h6>Update: Registration email error fixed!</h6>
            <div contenteditable="true" id="text" spellcheck="false"
                 style="border: thin solid black;padding: 3px;margin: 3px"></div>
            <!--            <div id="verify">-->
            <!--                <span id="verify-prompt"></span>-->
            <!--                <input type="number">-->
            <!--            </div>-->
            <!--            <input type="checkbox" id="replace"/><span>Auto replace with corrections</span><br>-->
            <button class="btn btn-success" id="analyze" onclick="analyze()">Analyze</button>
            <a class="btn btn-success" href="/acct">Register</a>
            <button class="btn btn-primary" id="copy" onclick="copy()">Copy</button>
            <!--            <button class="btn btn-primary" id="paste" onclick="paste()">Paste</button>-->
            <button class="btn btn-danger" onclick="clearInput()">Clear</button>
            <br>
            <br>
            <!--            <h6>AI grammar & style correction for English, Spanish, French, German, Italian, Chinese, Japanese, and-->
            <!--                more!</h6>-->
            <!--            <h6 id="free"><em>Free user restrictions: input length limited, daily queries limited</em></h6>-->
            <!--Short sentences may be misinterpreted to             be in another language.-->
            <!--            Upgrade to premium for uninterrupted use! By using our website you consent to our common sense-->
            <h6><a href="https://gist.github.com/karenina-io/83c690270ef41299c9ac95ee9903c2b4">Terms of use</a></h6>
            <div class="fb-share-button" data-href="https://karenina.io" data-layout="box_count"
                 data-size="large"><a target="_blank"
                                      href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fkarenina.io%2F&amp;src=sdkpreparse"
                                      class="fb-xfbml-parse-ignore">Share</a></div>
            <a class="twitter-share-button"
               href="https://twitter.com/intent/tweet"
               data-size="large">
                Tweet</a>

            <!--            <div class="fb-share-button" data-href="https://karenina.io" data-layout="box_count" data-size="large"><a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fkarenina.io%2F&amp;src=sdkpreparse" class="fb-xfbml-parse-ignore">Share</a></div>-->


            <!--            <div id="keys">-->
            <!--                <h5>Karenina IO Chrome extension hotkeys </h5>-->
            <!--                <h6>Alt+C: On any webpage copies selected text onto karenina.io and performs correction </h6>-->
            <!--                <h6>Alt+V: On karenina.io pastes the edited text back into the original webpage </h6>-->
            <!--            </div>-->
            <!--            <button class="btn btn-success" id="write" onclick="write()">Write</button>-->
        </div>
    </div>
    <!--        <div class="col">-->

    <!--            <h5>Output</h5>-->
    <!--            <p id="output"></p>-->
    <!--        </div>-->
    <!--    <div class="row">-->
    <!--        <div class="col">-->
    <!--            <h5>Sample inputs</h5>-->
    <!--            <button class="btn btn-outline-danger" onclick="fill(this)">he need buy aple and cereal. he will arrive-->
    <!--                there in 5 minutesss to make shopping in store-->
    <!--            </button>-->
    <!--            &lt;!&ndash;            <button class="btn btn-outline-danger" onclick="fill(this)">he need buy aple and cereal for lunch. he will be their in 5 minuts to make shopping in store</button>&ndash;&gt;-->
    <!--            <br>-->

    <!--            <button class="btn btn-outline-danger" onclick="fill(this)">我的中国文是很坏</button>-->
    <!--            <br>-->
    <!--&lt;!&ndash;            <button class="btn btn-outline-danger" onclick="fill(this)">我的中国文是很坏</button>&ndash;&gt;-->
    <!--&lt;!&ndash;            <br>&ndash;&gt;-->

    <!--            <button class="btn btn-outline-danger" onclick="fill(this)">me no gustar comer los pizza por almerzo-->
    <!--            </button>-->
    <!--            <br>-->

    <!--            <button class="btn btn-outline-danger" onclick="fill(this)">je aimer joue video jeux</button>-->
    <!--            <br>-->
    <!--            <br>-->


    <!--        </div>-->
    <!--    </div>-->
    <div class="row">
        <div class="col-3" id="ents">
        </div>
        <div class="col-9" id="docs">
        </div>
    </div>
</div>
<!--<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>-->



<!--Disclaimer-->
<!--* This software/document/website is offered “as-is”, without warranty, and disclaiming liability for damages resulting from its/their use.-->
