<div id="nav"><</div>


<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<!-- Popper JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<meta charset="UTF-8">

<!--    <title>Karenina IO multilingual grammar and style checker</title>-->

<div class="container" id="app">
    <div class="row">
        <div class="col">
            <div id="login">
                <h6>For more free daily usage, register by entering your email and choosing a password. If youâ€™re registered,
                    login with your credentials. </h6>
                <br>
                <div class="form-group">
                    <label for="email">Email address</label>
                    <input type="email" class="form-control" id="email" aria-describedby="emailHelp"
                           placeholder="Enter email">
                    <!--                    <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>-->
                </div>
                <div class="form-group">
                    <label for="pw">Password</label>
                    <input type="password" class="form-control" id="pw" placeholder="Password">
                </div>

                <button class="btn btn-success" id="loginreg">Login / Register</button>
            </div>
            <div id="acct">
                <div id="info">

                </div>
                <br>
                <!--                <form>-->
                <!--                    <div class="form-group">-->
                <h6>Registered users have more free daily usage :) If that's not enough, upgrade for uninterrupted use!</h6>
                <p>
                    We'll use your free daily quota first each time before touching your plan's character credits :)
                    Cancel anytime.
                </p>

                <input type="radio" name="plan" value=0>$5/month (25000 characters for occasional use)<br>
                <input type="radio" name="plan" value=1>$15/month (90000 characters for everyday use)<br>
                <!--                    <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>-->
                <button class="btn btn-success" id="pay">Upgrade</button>
                <br><br>
                <p>Cancel anytime! You can still use your remaining credits. If you run out of
                    credits, just subscribe again.
                    Your new plan will replace any previous plan and your remaining credits
                    will get transferred over.</p>
                <!--                    </div>-->
                <button class="btn btn-outline btn-danger" id="logout">Logout</button>
                <br>
                <br>
                <button class="btn btn-outline  btn-danger" id="cancel">Cancel plan</button>



            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>


<div id="footer"></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript">
$(document).ready(function(e) {
    $('#nav').load('/nav.html');
    $('#footer').load('/footer.html');
});
</script>

<script>
    const TEST = false
    var stripe = Stripe('pk_live_5VIOfPyZY0OroJwkjAagM76Z00LBZwAz1f');
    // var stripe = Stripe('pk_test_jcU9iD1IwrgZmgZAsv7qbX3900y57OLCtH');
    var url_string = window.location.href
    var url = new URL(url_string);
    var session_id = url.searchParams.get("session_id");

    if (session_id) {
    }


    function pay() {

        let data = {
            customer: localStorage.getItem('customer'),
            action: 'pay',
            plan: Number($('input[name=\'plan\']:checked').val()),
            // 'q': q.trim(),
        }

        query(data, r => {
            let {id} = r
            stripe.redirectToCheckout({
                // Make the id field from the Checkout Session creation API response
                // available to this file, so you can provide it as parameter here
                // instead of the {{CHECKOUT_SESSION_ID}} placeholder.
                sessionId: id
            }).then(function (result) {
                // If `redirectToCheckout` fails due to a browser or network
                // error, display the localized error message to your customer
                // using `result.error.message`.
            });

        })
    }

    function validateEmail(email) {
        const re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(email);
    }

    function login() {
        let email = $('#email').val()
        if (validateEmail(email)) {
            let data = {
                email: email,
                pw: $('#pw').val(),
                action: 'login'
            }
            query(data, r => {
                let {status} = r
                if(TEST) {
                    alert(r.msg)
                }
                switch (status) {
                    case 'success':
                        if (TEST) {
                            alert(r.customer)
                        }
                        localStorage.setItem("customer", r.customer);
                        refresh()
                        break
                    case 'error':
                        break
                }

            })
        } else {
            alert(`Invalid email`)
        }
    }

    function cancel() {

        let data = {
            customer: localStorage.getItem('customer'),
            action: 'cancel'
        }
        query(data, r => {
            alert(r.msg)
            refresh()
        })
    }

    function logout() {
        localStorage.removeItem('customer')
        refresh()
    }

    function info() {
        query({
            customer: localStorage.getItem('customer'),
            action: 'info'
        }, r => {
            // for (k of Object.keys(r)){
            //     localStorage.setItem(k,r[k])
            // }
            $('#info').html(`
            <h6>Email: ${r.email}</h6>
            <h6>Characters remaining: ${r.chars}</h6>
            <h6>Current subscription period ends: ${r.end}</h6>
            <h6>Subscription active: ${r.active}</h6>
            `)
        })
    }

    function refresh() {
        let customer = localStorage.getItem('customer');
        if (TEST) {
            alert('refresh')
            alert(customer)
        }
        if (customer) {

            $('#login').hide()
            $('#acct').show()
            info()
        } else {
            $('#login').show()
            $('#acct').hide()
        }
    }

for (x of ['loginreg','cancel','pay','logout']) {

    tmp="\""+x+"\""
    eval(`document.getElementById(${tmp}).addEventListener("click", ()=>${x}(), false)`);
}
    refresh()
</script>